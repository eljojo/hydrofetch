#!/usr/bin/env ruby

require_relative "../lib/hydrofetch"

require 'sinatra/base'

$scraper = Hydrofetch::Scraper.new(ENV["HYDRO_USER"], ENV["HYDRO_PASS"])

class HydrofetchWeb < Sinatra::Base
  access_logger = ::Logger.new($stdout)

  configure do
    use ::Rack::CommonLogger, access_logger
    Time.zone = 'America/Toronto'
  end

  before {
    env["rack.errors"] =  $stdout
    content_type 'application/json'
  }

  get('/') do
    next unless (result = $scraper.one_day_ago)
    hour_proportion = (Time.now.to_i % 3600) / 3600.0
    result[:consumed_kwh_proportional] = (result[:consumed_kwh] * hour_proportion).round(2)
    JSON.pretty_generate(result)
  end

  get('/report') do
    JSON.pretty_generate($scraper.report)
  end
end

if ARGV[0] == "server"
  HydrofetchWeb.run!(port: 8080)
else
  puts JSON.pretty_generate($scraper.one_day_ago)
end
