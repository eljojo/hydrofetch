#!/usr/bin/env ruby

require_relative "../lib/hydrofetch"

require 'sinatra/base'

scraper = Hydrofetch::Scraper.new(ENV["HYDRO_USER"], ENV["HYDRO_PASS"])

class HydrofetchWeb < Sinatra::Base
  access_logger = ::Logger.new($stdout)

  configure do
    use ::Rack::CommonLogger, access_logger
  end

  before {
    env["rack.errors"] =  access_logger
    content_type 'application/json'
  }

  get('/') do
    JSON.pretty_generate(scraper.one_day_ago)
  end

  get('/report') do
    JSON.pretty_generate(scraper.report)
  end
end
if ENV["APP_ENV"] == "production"
  HydrofetchWeb.run!(port: 8080) if HydrofetchWeb.app_file == $0
else
  puts JSON.pretty_generate(scraper.one_day_ago)
end
